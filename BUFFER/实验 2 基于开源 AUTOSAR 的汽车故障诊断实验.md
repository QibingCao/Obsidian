---

类型: 笔记
创建日期: 2024-06-05
修改日期: 2024-06-05
---
## 实验目的：

掌握 AUTOSAR 诊断管理包含的模块与工作流程，深入理解 DoIP 协议的时序与格式，实现在 AUTOSAR 上发送服务请求报文，以及在 Linux 上使用 Wireshark 抓包进行报文分析。
## 实验内容：
1. 掌握 AUTOSAR 的诊断管理模块与诊断流程
2. 解析 DoIP 协议
3. 发送故障状态请求报文
4. Linux 上使用 Wireshark 进行报文分析
## UDS协议
UDS（统一诊断服务）故障诊断协议是用于汽车电子控制单元（ECU）的标准化通信协议，用于车辆诊断和维护。它基于ISO 14229标准，提供了一组统一的服务，用于读取和控制ECU的诊断信息。“统一诊断服务”中的“统一”是指此标准是国际性标准，不是特定公司的专用标准。目前所有一阶供应商新生产的ECU都已支持此通信协议，也已集成到其他标准中，例如[AUTOSAR](https://zh.wikipedia.org/wiki/AUTOSAR "AUTOSAR")。现代汽车中的电子控制器控制了非常多的机能，包括[燃料喷射设备](https://zh.wikipedia.org/wiki/%E7%87%83%E6%96%99%E5%99%B4%E5%B0%84%E8%A3%9D%E7%BD%AE "燃料喷射设备")（EFI）、[发动机控制器](https://zh.wikipedia.org/wiki/%E5%8F%91%E5%8A%A8%E6%9C%BA%E6%8E%A7%E5%88%B6%E5%99%A8 "发动机控制器")、传动、[防锁死刹车系统](https://zh.wikipedia.org/wiki/%E9%98%B2%E9%94%81%E6%AD%BB%E5%88%B9%E8%BD%A6%E7%B3%BB%E7%BB%9F "防锁死刹车系统")（ABS）、门锁、刹车、窗户动作等。

诊断工具可以连接车上所有支持统一诊断服务功能的电子控制器。车上常用的[控制器局域网](https://zh.wikipedia.org/wiki/%E6%8E%A7%E5%88%B6%E5%99%A8%E5%8D%80%E5%9F%9F%E7%B6%B2%E8%B7%AF "控制器局域网")只用到[OSI模型](https://zh.wikipedia.org/wiki/OSI%E6%A8%A1%E5%9E%8B "OSI模型")的第一层及第二层，而统一诊断服务集成了OSI模型的第五层及第七层。
### UDS故障诊断协议的概念
UDS协议定义了一组标准化的诊断服务，这些服务允许诊断工具与ECU通信以执行以下任务：
1. **故障代码读取和清除**：读取和清除故障代码（DTC）。
2. **实时数据流读取**：获取ECU传感器和执行器的实时数据。
3. **ECU编程**：对ECU进行固件升级或重新编程。
4. **输入/输出控制**：控制ECU的输入和输出。
5. **安全访问**：保护敏感诊断功能，确保只有授权用户才能访问。
### 时序定义
UDS协议在通信时序上有严格的要求，以确保ECU和诊断工具之间的可靠通信。以下是一些关键的时序定义：
1. **请求和响应时间**：每个诊断请求都应在一定时间内得到响应，通常为几百毫秒到几秒不等。
2. **P2时间**：ECU在接收到诊断请求后，必须在规定的P2时间内做出响应。
3. **S3时间**：在没有活动通信的情况下，ECU在S3时间内进入低功耗模式。
4. **最大等待时间**：当ECU处理请求需要较长时间时，诊断工具需要等待ECU的响应，超过最大等待时间会认为通信失败。
5. 常用服务如下![[Pasted image 20240614200034.png]]
## wireshark安装
执行如下命令：
`sudo add-apt-repository universe`
`sudo apt install wireshark`
选择Yes
![[Pasted image 20240605173133.png]]
#### 修改group文件
`sudo vim /etc/group`
![[Pasted image 20240605173237.png]]
#### 启动wireshark
注意要开启su权限
`sudo wireshark`
#### 发送路由激活和服务请求报文
```
cd as/
./autorun.sh

cd socket_tool/
make
sudo ./send_client.sh
```
在代码中直接配置死的IP **172.18.0.200**，端口**13400**并不需要我们手动配置。

结果如下：
![[Pasted image 20240605190940.png]]
![[Pasted image 20240605190959.png]]
## 实验结果分析
实验结果图中用wirkshark抓包了我们发送的DoIP报文。DoIP通讯协议的过程如下。
![[Pasted image 20240614201112.png]]
我们发送的报文一的目的是路由激活，报文内容为`02 fd 00 05 00 00 00 07 be ef da 00 00 00 00`，可以看到这条DoIP报文基于TCP，目的端口是13400，从172.18.0.1发给172.18.0.200，功能是0x0005 **路由激活**，源地址是0xbeef 激活类型是0xda。
我们发送的报文二的目的是**诊断请求**，报文内容为`02 fd 80 01 00 00 00 06 be ef fe ed 11 01`，可以看到这条报文是DoIP报文的基础上又封装了UDS报文。DoIP报文的功能类型是0x8001**诊断请求**，源地址是0xbeef，目的地址是0xfeed。根据上文图中对UDS报文内容的分析，UDS报文里面服务id是0x11**ECU复位**，类型是0x01**硬复位**。
